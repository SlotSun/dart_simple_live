app-id: io.github.SlotSun.dart_simple_live
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm21
command: Slive
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --talk-name=org.freedesktop.ScreenSaver
  # user settings synchronization feature requires this D-Bus
  - --system-talk-name=org.freedesktop.NetworkManager.IP4Config
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /man
  - /share/man
  - /share/doc
  - /share/gtk-docmodules

modules:
  - name: libmpv
    buildsystem: meson
    cleanup:
      - /bin
      - /share/applications
      - /share/bash-completion
      - /share/icons
      - /share/zsh
      - /share/metainfo
    config-opts:
      - -Dalsa=enabled
      - -Dbuild-date=false
      - -Dcdda=disabled
      - -Dcplayer=true
      - -Dcplugins=enabled
      - -Dcuda-hwaccel=enabled
      - -Dcuda-interop=enabled
      - -Ddmabuf-wayland=enabled
      - -Ddrm=enabled
      - -Ddvbin=enabled
      - -Ddvdnav=disabled
      - -Degl-drm=enabled
      - -Degl-wayland=enabled
      - -Degl-x11=enabled
      - -Degl=enabled
      - -Dgbm=enabled
      - -Dgl-x11=enabled
      - -Dgl=enabled
      - -Diconv=enabled
      - -Djack=enabled
      - -Djavascript=disabled
      - -Djpeg=enabled
      - -Dlcms2=enabled
      - -Dlibarchive=enabled
      - -Dlibavdevice=enabled
      - -Dlibbluray=disabled
      - -Dlibmpv=true
      - -Dlua=enabled
      - -Dmanpage-build=disabled
      - -Dopenal=enabled
      - -Dpipewire=enabled
      - -Dplain-gl=enabled
      - -Dpulse=enabled
      - -Drubberband=disabled
      - -Dsdl2-audio=enabled
      - -Dsdl2-gamepad=enabled
      - -Dsdl2-video=enabled
      - -Dsdl2=enabled
      - -Duchardet=disabled
      - -Dvaapi-drm=enabled
      - -Dvaapi-wayland=enabled
      - -Dvaapi-x11=enabled
      - -Dvaapi=enabled
      - -Dvapoursynth=disabled
      - -Dvdpau-gl-x11=enabled
      - -Dvdpau=enabled
      - -Dvector=enabled
      - -Dvulkan=enabled
      - -Dwayland=enabled
      - -Dwerror=false
      - -Dx11=enabled
      - -Dxv=enabled
      - -Dzimg=disabled
      - -Dzlib=enabled
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.40.0
        commit: e48ac7ce08462f5e33af6ef9deeac6fa87eef01e
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

    modules:
      # Hard dependency of mpv
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dshaderc=enabled
          - -Dd3d11=disabled
          - -Ddemos=false
        sources:
          - type: git
            url: https://code.videolan.org/videolan/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
          - type: patch
            path: libplacebo-python-3.14.patch
        modules:
          # runtime shaderc is broken for mpv build.
          - name: shaderc
            buildsystem: cmake-ninja
            builddir: true
            config-opts:
              - -DSHADERC_SKIP_COPYRIGHT_CHECK=ON
              - -DSHADERC_SKIP_EXAMPLES=ON
              - -DSHADERC_SKIP_TESTS=ON
              - -DSPIRV_SKIP_EXECUTABLES=ON
              - -DENABLE_GLSLANG_BINARIES=OFF
            cleanup:
              - /bin
              - /include
              - /lib/cmake
              - /lib/pkgconfig
            sources:
              - type: git
                url: https://github.com/google/shaderc.git
                tag: v2025.4
                commit: 73743588fe9c39f2f1c780a087d94afac691a189
                x-checker-data:
                  type: git
                  tag-pattern: ^v(\d{4}\.\d{1,2})$
              - type: git
                url: https://github.com/KhronosGroup/SPIRV-Headers.git
                tag: vulkan-sdk-1.4.328.1
                commit: 01e0577914a75a2569c846778c2f93aa8e6feddd
                dest: third_party/spirv-headers
                x-checker-data:
                  type: git
                  tag-pattern: ^vulkan-sdk-([\d.]+)$
              - type: git
                url: https://github.com/KhronosGroup/SPIRV-Tools.git
                tag: vulkan-sdk-1.4.328.1
                commit: 7f2d9ee926f98fc77a3ed1e1e0f113b8c9c49458
                dest: third_party/spirv-tools
                x-checker-data:
                  type: git
                  tag-pattern: ^vulkan-sdk-([\d.]+)$
              - type: git
                url: https://github.com/KhronosGroup/glslang.git
                tag: vulkan-sdk-1.4.328.1
                commit: a57276bf558f5cf94d3a9854ebdf5a2236849a5a
                dest: third_party/glslang
                x-checker-data:
                  type: git
                  tag-pattern: ^vulkan-sdk-([\d.]+)$

      # Hard dependency of mpv
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: git
            url: https://github.com/libass/libass.git
            tag: 0.17.4
            commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)$

      # Lua to display mpv play info
      - name: luajit
        no-autogen: true
        cleanup:
          - /bin
          - /include
          - /lib/pkgconfig
          - /share/man
        sources:
          - type: git
            url: https://github.com/openresty/luajit2.git
            tag: v2.1-20251030
            commit: 71fae383f6c4637d64b03a6d0ec76ae8c19d6821
            x-checker-data:
              type: git
              tag-pattern: ^v2.1-([\d\.\-]+)$
          - type: shell
            commands:
              - sed -i 's|/usr/local|/app|' ./Makefile

      # X11
      - name: libXpresent
        buildsystem: autotools
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/xorg/lib/libxpresent.git
            tag: libXpresent-1.0.2
            commit: 4d92149372461bf575e8a09b1064a2884c38c3aa
            x-checker-data:
              type: git
              tag-pattern: ^libXpresent-([\d.]+)$

      # Hardware acceleration
      - name: libdisplay-info
        buildsystem: meson
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/emersion/libdisplay-info.git
            tag: 0.3.0
            commit: 47a5590e9c4eb35d67651b8c05a55f1a48259329
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)$
        modules:
          - name: hwdata
            buildsystem: autotools
            sources:
              - type: git
                url: https://github.com/vcrhonek/hwdata.git
                tag: v0.400
                commit: f5ce55230206fd647bbcae42012094eb04640740
                x-checker-data:
                  type: git
                  tag-pattern: ^v([\d.]+)$

  - name: dart_simple_live
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
      arch:
        x86_64:
          env:
            BUNDLE_PATH: simple_live_app/build/linux/x64/release/bundle
        aarch64:
          env:
            BUNDLE_PATH: simple_live_app/build/linux/arm64/release/bundle
      append-path: /usr/lib/sdk/llvm21/bin:/run/build/dart_simple_live/flutter/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm21/lib
      env:
        PUB_CACHE: /run/build/dart_simple_live/.pub-cache
    build-commands:
      - cd simple_live_app && flutter build linux --release
      - install -dvm755 ${FLATPAK_DEST}/bin
      - cp -av ${BUNDLE_PATH}/* ${FLATPAK_DEST}/bin
      - install -Dvm644 simple_live_app/assets/${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - install -Dvm644 simple_live_app/assets/images/logo.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dvm644 simple_live_app/assets/${FLATPAK_ID}.desktop -t ${FLATPAK_DEST}/share/applications
    sources:
      - type: dir
        path: "../"
      - type: git
        url: https://github.com/flutter/flutter.git
        tag: 3.35.7
        commit: adc901062556672b4138e18a4dc62a4be8f4b3c2
        dest: flutter
